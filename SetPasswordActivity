package com.SIMATS.rise;

import android.content.Intent;
import android.os.Bundle;
import android.widget.*;
import androidx.appcompat.app.AppCompatActivity;

import com.SIMATS.rise.api.ApiClient;
import com.SIMATS.rise.api.ApiService;
import com.SIMATS.rise.model.ResetPasswordRequest;
import com.SIMATS.rise.model.ResetPasswordResponse;

import retrofit2.Call;
import retrofit2.Callback;
import retrofit2.Response;

public class SetPasswordActivity extends AppCompatActivity {

    EditText setPassword, confirmPassword;
    Button submitPasswordBtn;
    TextView emailVerifiedText;
    String email;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_set_password);

        emailVerifiedText = findViewById(R.id.emailVerifiedText);
        setPassword = findViewById(R.id.setPassword);
        confirmPassword = findViewById(R.id.confirmPassword);
        submitPasswordBtn = findViewById(R.id.submitPasswordBtn);

        email = getIntent().getStringExtra("email");
        emailVerifiedText.setText("Verified Email: " + email);

        submitPasswordBtn.setOnClickListener(v -> {
            String pass = setPassword.getText().toString();
            String confirm = confirmPassword.getText().toString();

            if (pass.isEmpty() || confirm.isEmpty()) {
                Toast.makeText(this, "Please enter both passwords", Toast.LENGTH_SHORT).show();
            } else if (!pass.equals(confirm)) {
                Toast.makeText(this, "Passwords do not match", Toast.LENGTH_SHORT).show();
            } else {
                resetPassword(email, pass);
            }
        });
    }

    private void resetPassword(String email, String newPassword) {
        ApiService apiService = ApiClient.getRetrofit().create(ApiService.class);
        ResetPasswordRequest request = new ResetPasswordRequest(email, newPassword);

        apiService.resetPassword(request).enqueue(new Callback<ResetPasswordResponse>() {
            @Override
            public void onResponse(Call<ResetPasswordResponse> call, Response<ResetPasswordResponse> response) {
                if (response.isSuccessful() && response.body() != null) {
                    ResetPasswordResponse res = response.body();
                    if (res.getStatus().contains("success")) {
                        Toast.makeText(SetPasswordActivity.this, res.getMessage(), Toast.LENGTH_SHORT).show();
                        // Go to login screen or home
                        Intent intent = new Intent(SetPasswordActivity.this, LetsBeginActivity.class);
                        startActivity(intent);
                        finish();
                    } else {
                        Toast.makeText(SetPasswordActivity.this, res.getMessage(), Toast.LENGTH_SHORT).show();
                    }
                } else {
                    Toast.makeText(SetPasswordActivity.this, "Server Error: " + response.code(), Toast.LENGTH_LONG).show();
                }
            }

            @Override
            public void onFailure(Call<ResetPasswordResponse> call, Throwable t) {
                Toast.makeText(SetPasswordActivity.this, "Network Error: " + t.getMessage(), Toast.LENGTH_LONG).show();
            }
        });
    }
}
